{"version":3,"sources":["../src/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","panel","find","$tooltip","$","events","on","render","legendType","setTimeout","setElementHeight","height","row","_","isString","parseInt","replace","title","css","e","formatter","label","slice","fontSize","color","Math","round","percent","noDataPoints","html","addPieChart","width","size","min","plotCanvas","plotCss","top","margin","position","$panelContainer","parents","backgroundColor","options","legend","show","series","pie","stroke","parseFloat","strokeWidth","toFixed","highlight","opacity","combine","threshold","grid","hoverable","clickable","pieType","innerRadius","plot","tooltip","bind","event","pos","item","type","variableName","variable","name","variableSrv","variables","current","text","value","updateOptions","then","variableUpdated","$emit","$root","$broadcast","detach","body","formatted","formatValue","showValue","showPercentage","place_tt","pageX","pageY","incrementRenderCounter","length","renderingCompleted"],"mappings":"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","file":"rendering.js","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\nimport 'jquery.flot';\nimport 'jquery.flot.pie';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  var data, panel;\n  elem = elem.find('.piechart-panel');\n  var $tooltip = $('<div id=\"tooltip\">');\n\n  ctrl.events.on('render', function() {\n    render(false);\n    if(panel.legendType === 'Right side') {\n      setTimeout(function() { render(true); }, 50);\n    }\n  });\n\n  function setElementHeight() {\n    try {\n      var height = ctrl.height || panel.height || ctrl.row.height;\n      if (_.isString(height)) {\n        height = parseInt(height.replace('px', ''), 10);\n      }\n\n      height -= 5; // padding\n      height -= panel.title ? 24 : 9; // subtract panel title bar\n\n      elem.css('height', height + 'px');\n\n      return true;\n    } catch(e) { // IE throws errors sometimes\n      return false;\n    }\n  }\n\n  function formatter(label, slice) {\n    return \"<div style='font-size:\" + ctrl.panel.fontSize + \";text-align:center;padding:2px;color:\" + slice.color + \";'>\" + label + \"<br/>\" + Math.round(slice.percent) + \"%</div>\";\n  }\n\n  function noDataPoints() {\n\n    var html = '<div class=\"datapoints-warning\"><span class=\"small\">No data points</span></div>';\n\n    elem.html(html);\n  }\n\n  function addPieChart() {\n    var width = elem.width();\n    var height = elem.height();\n\n    var size = Math.min(width, height);\n\n    var plotCanvas = $('<div></div>');\n    var plotCss = {\n      top: '10px',\n      margin: 'auto',\n      position: 'relative',\n      height: (size - 20) + 'px'\n    };\n\n    plotCanvas.css(plotCss);\n\n    var $panelContainer = elem.parents('.panel-container');\n    var backgroundColor = $panelContainer.css('background-color');\n\n    var options = {\n      legend: {\n        show: false\n      },\n      series: {\n        pie: {\n          show: true,\n          stroke: {\n            color: backgroundColor,\n            width: parseFloat(ctrl.panel.strokeWidth).toFixed(1)\n          },\n          label: {\n            show: ctrl.panel.legend.show && ctrl.panel.legendType === 'On graph',\n            formatter: formatter\n          },\n          highlight: {\n            opacity: 0.0\n          },\n\t\t  combine: {\n\t\t    threshold: ctrl.panel.combine.threshold,\n\t\t\tlabel: ctrl.panel.combine.label\n\t\t  }\n        }\n      },\n      grid: {\n        hoverable: true,\n        clickable: true\n      }\n    };\n\n    if (panel.pieType === 'donut') {\n      options.series.pie.innerRadius = 0.5;\n    }\n\n    elem.html(plotCanvas);\n\n    $.plot(plotCanvas, ctrl.data, options);\n\n    if (ctrl.panel.tooltip.show === true) {\n      plotCanvas.bind(\"plotclick plothover\", function (event, pos, item) {\n        if (event.type == \"plotclick\") {\n          const label = item.series.label;\n\n          const variableName = ctrl.panel.variable.name;\n          if (variableName) {\n            const variable = _.find(ctrl.variableSrv.variables, {\"name\": variableName});\n            variable.current.text = label;\n            variable.current.value = label;\n\n            ctrl.variableSrv.updateOptions(variable).then(() => {\n              ctrl.variableSrv.variableUpdated(variable).then(() => {\n                scope.$emit('template-variable-value-updated');\n                scope.$root.$broadcast('refresh');\n              });\n            });\n          }\n        } else if (event.type == \"plothover\") {\n          if (!item) {\n            $tooltip.detach();\n            return;\n          }\n\n          var body;\n          var percent = parseFloat(item.series.percent).toFixed(2);\n          var formatted = ctrl.formatValue(item.series.data[0][1]);\n\n          body = '<div class=\"graph-tooltip-small\"><div class=\"graph-tooltip-time\">';\n          body += '<div class=\"graph-tooltip-value\">' + item.series.label;\n          if (ctrl.panel.tooltip.showValue === true) {\n            body += ': ' + formatted;\n          }\n          if (ctrl.panel.tooltip.showPercentage === true) {\n            body += \" (\" + percent + \"%)\";\n          }\n          body += \"</div>\";\n          body += \"</div></div>\";\n\n          $tooltip.html(body).place_tt(pos.pageX + 20, pos.pageY);\n        }\n      });\n    } else {\n      $tooltip.detach();\n    }\n  }\n\n  function render(incrementRenderCounter) {\n    if (!ctrl.data) { return; }\n\n    data = ctrl.data;\n    panel = ctrl.panel;\n\n    if (setElementHeight()) {\n      if (0 == ctrl.data.length) {\n        noDataPoints();\n      } else {\n        addPieChart();\n      }\n    }\n    if (incrementRenderCounter) {\n      ctrl.renderingCompleted();\n    }\n  }\n}\n\n"]}