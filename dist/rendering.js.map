{"version":3,"sources":["../src/rendering.js"],"names":[],"mappings":"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","file":"rendering.js","sourcesContent":["import _ from 'lodash';\nimport $ from 'jquery';\nimport 'jquery.flot';\nimport 'jquery.flot.pie';\n\nexport default function link(scope, elem, attrs, ctrl) {\n  var data, panel;\n  elem = elem.find('.piechart-panel');\n  var $tooltip = $('<div id=\"tooltip\">');\n\n  ctrl.events.on('render', function() {\n    render();\n    ctrl.renderingCompleted();\n  });\n\n  function setElementHeight() {\n    try {\n      var height = ctrl.height || panel.height || ctrl.row.height;\n      if (_.isString(height)) {\n        height = parseInt(height.replace('px', ''), 10);\n      }\n\n      height -= 5; // padding\n      height -= panel.title ? 24 : 9; // subtract panel title bar\n\n      elem.css('height', height + 'px');\n\n      return true;\n    } catch(e) { // IE throws errors sometimes\n      return false;\n    }\n  }\n\n  function formatter(label, slice) {\n    return \"<div style='font-size:\" + ctrl.panel.fontSize + \";text-align:center;padding:2px;color:\" + slice.color + \";'>\" + label + \"<br/>\" + Math.round(slice.percent) + \"%</div>\";\n  }\n\n  function addPieChart() {\n    var width = elem.width();\n    var height = elem.height();\n\n    var size = Math.min(width, height);\n\n    var plotCanvas = $('<div></div>');\n    var plotCss = {\n      top: '10px',\n      margin: 'auto',\n      position: 'relative',\n      height: (size - 20) + 'px'\n    };\n\n    plotCanvas.css(plotCss);\n\n    var $panelContainer = elem.parents('.panel-container');\n\n    var options = {\n      legend: {\n        show: false\n      },\n      series: {\n        pie: {\n          innerRadius: 0.5,\n          show: true,\n          stroke: {\n            // stroke color does not support rgba colors\n            color: 'rgb(255,255,255)',\n            width: parseFloat(ctrl.panel.strokeWidth).toFixed(1)\n          },\n          label: {\n            show: ctrl.panel.legend.show && ctrl.panel.legendType === 'On graph',\n            formatter: formatter\n          },\n          highlight: {\n            opacity: 0.0\n          }\n        }\n      },\n      grid: {\n        hoverable: true,\n        clickable: ctrl.panel.clickable\n      }\n    };\n\n    if (panel.pieType === 'donut') {\n      options.series.pie.innerRadius = 0.5;\n    } else {\n      options.series.pie.innerRadius = 0;\n    }\n\n    elem.html(plotCanvas);\n\n    var plot = $.plot(plotCanvas, ctrl.data, options);\n    plotCanvas.bind(\"plothover\", function (event, pos, item) {\n      var $panelContainer = $(event.target).parents(\".panel-container\");\n      if (!item) {\n        _.each( $panelContainer.find(\".graph-legend-series\"), function(legend) {\n         $(legend).css(\"opacity\",\"1.0\");\n        });\n        $tooltip.detach();\n        return;\n      }\n      \n      _.each( $panelContainer.find(\".graph-legend-series\"), function(legend) {\n       if ( $(legend).attr(\"data-series-key\") !== item.series.label ) {\n         $(legend).css(\"opacity\",\"0.5\");\n       } else {\n         $(legend).css(\"opacity\",\"1\");\n       }\n      });\n\n      var body;\n      var percent = parseFloat(item.series.percent).toFixed(2);\n      var formatted = ctrl.formatValue(item.series.data[0][1]);\n\n      body = '<div class=\"graph-tooltip-small\"><div class=\"graph-tooltip-time\">';\n      body += '<div class=\"graph-tooltip-value\">' + item.series.label + ': ' + formatted;\n      body += \" (\" + percent + \"%)\" + '</div>';\n      body += \"</div></div>\";\n\n      $tooltip.html(body).place_tt(pos.pageX + 20, pos.pageY);\n    });\n   \n    if (ctrl.panel.clickable) {\n      plotCanvas.bind(\"plotclick\", function (evt, pos, item) {\n        ctrl.handle_click_event(this, evt, item.series.label.trim());\n      });\n    }\n  }\n\n  function render() {\n    if (!ctrl.data) { return; }\n\n    data = ctrl.data;\n    panel = ctrl.panel;\n\n    setTimeout( function() {\n      if (setElementHeight()) {\n        addPieChart();\n      }\n    }, 1000);\n  }\n}\n\n"]}