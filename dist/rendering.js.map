{"version":3,"sources":["../src/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","panel","find","$tooltip","$","events","on","render","legendType","setTimeout","setElementHeight","height","row","_","isString","parseInt","replace","title","css","e","isDrilldown","drilldowns","length","formatter","label","slice","fontSize","color","Math","round","percent","addPieChart","width","size","min","plotCanvas","plotCss","top","margin","position","$panelContainer","parents","backgroundColor","options","legend","show","series","pie","stroke","parseFloat","strokeWidth","toFixed","highlight","opacity","combine","threshold","grid","hoverable","clickable","pieType","innerRadius","html","plot","bind","event","pos","item","linkSrv","$injector","get","y","drilldown","regexp","RegExp","alias","test","scopedVars","separator","trim","values","split","i","repeat","value","getPanelLinkAnchorInfo","targetBlank","window","open","href","detach","body","formatted","formatValue","place_tt","pageX","pageY","incrementRenderCounter","renderingCompleted"],"mappings":"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","file":"rendering.js","sourcesContent":["import _ from 'lodash';\r\nimport $ from 'jquery';\r\nimport 'jquery.flot';\r\nimport 'jquery.flot.pie';\r\n\r\nexport default function link(scope, elem, attrs, ctrl) {\r\n    var data, panel;\r\n    elem = elem.find('.piechart-panel');\r\n    var $tooltip = $('<div id=\"tooltip\">');\r\n\r\n    ctrl.events.on('render', function () {\r\n        render(false);\r\n        if (panel.legendType === 'Right side') {\r\n            setTimeout(function () {\r\n                render(true);\r\n            }, 50);\r\n        }\r\n    });\r\n\r\n    function setElementHeight() {\r\n        try {\r\n            var height = ctrl.height || panel.height || ctrl.row.height;\r\n            if (_.isString(height)) {\r\n                height = parseInt(height.replace('px', ''), 10);\r\n            }\r\n\r\n            height -= 5; // padding\r\n            height -= panel.title ? 24 : 9; // subtract panel title bar\r\n\r\n            elem.css('height', height + 'px');\r\n\r\n            return true;\r\n        } catch (e) { // IE throws errors sometimes\r\n            return false;\r\n        }\r\n    }\r\n\r\n    function isDrilldown(){\r\n        if(ctrl.panel.drilldowns && ctrl.panel.drilldowns.length > 0) {\r\n            return true\r\n        }else{\r\n            return false;\r\n        }\r\n    }\r\n\r\n    function formatter(label, slice) {\r\n        return \"<div style='font-size:\" + ctrl.panel.fontSize + \";text-align:center;padding:2px;color:\" + slice.color + \";'>\" + label + \"<br/>\" + Math.round(slice.percent) + \"%</div>\";\r\n    }\r\n\r\n    function addPieChart() {\r\n        var width = elem.width();\r\n        var height = elem.height();\r\n\r\n        var size = Math.min(width, height);\r\n\r\n        var plotCanvas = $('<div></div>');\r\n        var plotCss = {\r\n            top: '10px',\r\n            margin: 'auto',\r\n            position: 'relative',\r\n            height: (size - 20) + 'px'\r\n        };\r\n\r\n        plotCanvas.css(plotCss);\r\n\r\n        var $panelContainer = elem.parents('.panel-container');\r\n        var backgroundColor = $panelContainer.css('background-color');\r\n\r\n        var options = {\r\n            legend: {\r\n                show: false\r\n            },\r\n            series: {\r\n                pie: {\r\n                    show: true,\r\n                    stroke: {\r\n                        color: backgroundColor,\r\n                        width: parseFloat(ctrl.panel.strokeWidth).toFixed(1)\r\n                    },\r\n                    label: {\r\n                        show: ctrl.panel.legend.show && ctrl.panel.legendType === 'On graph',\r\n                        formatter: formatter\r\n                    },\r\n                    highlight: {\r\n                        opacity: 0.0\r\n                    },\r\n                    combine: {\r\n                        threshold: ctrl.panel.combine.threshold,\r\n                        label: ctrl.panel.combine.label\r\n                    }\r\n                }\r\n            },\r\n            grid: {\r\n                hoverable: true,\r\n                clickable: isDrilldown\r\n            }\r\n        };\r\n\r\n        if (panel.pieType === 'donut') {\r\n            options.series.pie.innerRadius = 0.5;\r\n        }\r\n\r\n        elem.html(plotCanvas);\r\n\r\n        $.plot(plotCanvas, ctrl.data, options);\r\n\r\n        plotCanvas.bind(\"plotclick\", function (event, pos, item) {\r\n            var panel = ctrl.panel;\r\n            if (!item || !panel.drilldowns || panel.drilldowns.length == 0) {\r\n                return;\r\n            }\r\n\r\n            var linkSrv = ctrl.$injector.get('linkSrv');\r\n\r\n            for (var y = 0; y < panel.drilldowns.length; y++) {\r\n\r\n                var drilldown = panel.drilldowns[y];\r\n\r\n                var regexp = new RegExp(drilldown.alias);\r\n                var alias = item.series.label;\r\n                if (regexp.test(alias)) {\r\n                    var scopedVars = {};\r\n                    scopedVars[\"alias\"] = {\"value\": alias};\r\n\r\n                    if (drilldown.separator && drilldown.separator.trim().length > 0) {\r\n                        var values = alias.split(drilldown.separator);\r\n                        for (var i = 0; i < values.length; i++) {\r\n                            scopedVars[\"alias\" + i] = {\"value\": values[i]};\r\n                        }\r\n                    }\r\n\r\n                    //add panel.scopedVars for repeat var\r\n                    if (panel.repeat && panel.scopedVars[panel.repeat] && panel.scopedVars[panel.repeat].value) {\r\n                        scopedVars[panel.repeat] = {\"value\": panel.scopedVars[panel.repeat].value};\r\n                    }\r\n\r\n                    var link = linkSrv.getPanelLinkAnchorInfo(drilldown, scopedVars);\r\n\r\n                    if (drilldown.targetBlank) {\r\n                        window.open(link.href, '_blank');\r\n                    } else {\r\n                        window.open(link.href, '_self');\r\n                    }\r\n                }\r\n            }\r\n        });\r\n        plotCanvas.bind(\"plothover\", function (event, pos, item) {\r\n            if (!item) {\r\n                $tooltip.detach();\r\n                return;\r\n            }\r\n\r\n            if(isDrilldown()){\r\n                plotCanvas.css('cursor','pointer');\r\n            }\r\n\r\n            var body;\r\n            var percent = parseFloat(item.series.percent).toFixed(2);\r\n            var formatted = ctrl.formatValue(item.series.data[0][1]);\r\n\r\n            body = '<div class=\"graph-tooltip-small\"><div class=\"graph-tooltip-time\">';\r\n            body += '<div class=\"graph-tooltip-value\">' + item.series.label + ': ' + formatted;\r\n            body += \" (\" + percent + \"%)\" + '</div>';\r\n            body += \"</div></div>\";\r\n\r\n            $tooltip.html(body).place_tt(pos.pageX + 20, pos.pageY);\r\n        });\r\n\r\n\r\n    }\r\n\r\n    function render(incrementRenderCounter) {\r\n        if (!ctrl.data) {\r\n            return;\r\n        }\r\n\r\n        data = ctrl.data;\r\n        panel = ctrl.panel;\r\n\r\n        if (setElementHeight()) {\r\n            addPieChart();\r\n        }\r\n        if (incrementRenderCounter) {\r\n            ctrl.renderingCompleted();\r\n        }\r\n    }\r\n}\r\n\r\n"]}