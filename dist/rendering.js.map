{"version":3,"sources":["../src/rendering.js"],"names":["link","scope","elem","attrs","ctrl","data","panel","find","$tooltip","$","events","on","render","legendType","setTimeout","setElementHeight","height","row","_","isString","parseInt","replace","title","css","e","formatter","label","slice","fontSize","color","Math","round","percent","addPieChart","width","size","min","plotCanvas","plotCss","top","margin","position","$panelContainer","parents","backgroundColor","options","legend","show","series","pie","stroke","parseFloat","strokeWidth","toFixed","highlight","opacity","combine","threshold","grid","hoverable","clickable","sectors","drilldown","pieType","innerRadius","html","plot","bind","event","pos","item","url","template","linkSrv","$injector","get","timeSrv","templateSrv","scopedVars","keepTime","range","timeRangeForUrl","from","to","includeVars","fillVariableValuesForUrl","addParamsToUrl","targetBlank","window","open","detach","body","formatted","formatValue","place_tt","pageX","pageY","incrementRenderCounter","renderingCompleted"],"mappings":"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","file":"rendering.js","sourcesContent":["import _ from 'lodash';\r\nimport $ from 'jquery';\r\nimport 'jquery.flot';\r\nimport 'jquery.flot.pie';\r\n\r\nexport default function link(scope, elem, attrs, ctrl) {\r\n    var data, panel;\r\n    elem = elem.find('.piechart-panel');\r\n    var $tooltip = $('<div id=\"tooltip\">');\r\n\r\n    ctrl.events.on('render', function () {\r\n        render(false);\r\n        if (panel.legendType === 'Right side') {\r\n            setTimeout(function () {\r\n                render(true);\r\n            }, 50);\r\n        }\r\n    });\r\n\r\n    function setElementHeight() {\r\n        try {\r\n            var height = ctrl.height || panel.height || ctrl.row.height;\r\n            if (_.isString(height)) {\r\n                height = parseInt(height.replace('px', ''), 10);\r\n            }\r\n\r\n            height -= 5; // padding\r\n            height -= panel.title ? 24 : 9; // subtract panel title bar\r\n\r\n            elem.css('height', height + 'px');\r\n\r\n            return true;\r\n        } catch (e) { // IE throws errors sometimes\r\n            return false;\r\n        }\r\n    }\r\n\r\n    function formatter(label, slice) {\r\n        return \"<div style='font-size:\" + ctrl.panel.fontSize + \";text-align:center;padding:2px;color:\" + slice.color + \";'>\" + label + \"<br/>\" + Math.round(slice.percent) + \"%</div>\";\r\n    }\r\n\r\n    function addPieChart() {\r\n        var width = elem.width();\r\n        var height = elem.height();\r\n\r\n        var size = Math.min(width, height);\r\n\r\n        var plotCanvas = $('<div></div>');\r\n        var plotCss = {\r\n            top: '10px',\r\n            margin: 'auto',\r\n            position: 'relative',\r\n            height: (size - 20) + 'px'\r\n        };\r\n\r\n        plotCanvas.css(plotCss);\r\n\r\n        var $panelContainer = elem.parents('.panel-container');\r\n        var backgroundColor = $panelContainer.css('background-color');\r\n\r\n        var options = {\r\n            legend: {\r\n                show: false\r\n            },\r\n            series: {\r\n                pie: {\r\n                    show: true,\r\n                    stroke: {\r\n                        color: backgroundColor,\r\n                        width: parseFloat(ctrl.panel.strokeWidth).toFixed(1)\r\n                    },\r\n                    label: {\r\n                        show: ctrl.panel.legend.show && ctrl.panel.legendType === 'On graph',\r\n                        formatter: formatter\r\n                    },\r\n                    highlight: {\r\n                        opacity: 0.0\r\n                    },\r\n                    combine: {\r\n                        threshold: ctrl.panel.combine.threshold,\r\n                        label: ctrl.panel.combine.label\r\n                    }\r\n                }\r\n            },\r\n            grid: {\r\n                hoverable: true,\r\n                clickable: ctrl.panel.sectors.drilldown?true:false\r\n            }\r\n        };\r\n\r\n        if (panel.pieType === 'donut') {\r\n            options.series.pie.innerRadius = 0.5;\r\n        }\r\n\r\n        elem.html(plotCanvas);\r\n\r\n        $.plot(plotCanvas, ctrl.data, options);\r\n\r\n        plotCanvas.bind(\"plotclick\", function (event, pos, item) {\r\n            if (!item || !ctrl.panel.sectors.drilldown) {\r\n                return;\r\n            }\r\n            var url = ctrl.panel.sectors.url.template.replace(\"$label\", item.series.label);\r\n\r\n            var linkSrv = ctrl.$injector.get('linkSrv');\r\n            var timeSrv = ctrl.$injector.get('timeSrv');\r\n            var templateSrv = ctrl.$injector.get('templateSrv');\r\n\r\n\r\n            var scopedVars = {}\r\n\r\n            if (ctrl.panel.sectors.url.keepTime) {\r\n                var range = timeSrv.timeRangeForUrl();\r\n                scopedVars['from'] = range.from;\r\n                scopedVars['to'] = range.to;\r\n            }\r\n\r\n            if (ctrl.panel.sectors.url.includeVars) {\r\n                templateSrv.fillVariableValuesForUrl(scopedVars);\r\n            }\r\n\r\n            url = linkSrv.addParamsToUrl(url, scopedVars);\r\n\r\n            if (ctrl.panel.sectors.url.targetBlank) {\r\n                window.open(url, '_blank');\r\n            } else {\r\n                window.open(url, '_self');\r\n            }\r\n\r\n        });\r\n        plotCanvas.bind(\"plothover\", function (event, pos, item) {\r\n            if (!item) {\r\n                $tooltip.detach();\r\n                return;\r\n            }\r\n\r\n            if(ctrl.panel.sectors.drilldown){\r\n                plotCanvas.css('cursor','pointer');\r\n            }\r\n\r\n            var body;\r\n            var percent = parseFloat(item.series.percent).toFixed(2);\r\n            var formatted = ctrl.formatValue(item.series.data[0][1]);\r\n\r\n            body = '<div class=\"graph-tooltip-small\"><div class=\"graph-tooltip-time\">';\r\n            body += '<div class=\"graph-tooltip-value\">' + item.series.label + ': ' + formatted;\r\n            body += \" (\" + percent + \"%)\" + '</div>';\r\n            body += \"</div></div>\";\r\n\r\n            $tooltip.html(body).place_tt(pos.pageX + 20, pos.pageY);\r\n        });\r\n\r\n\r\n    }\r\n\r\n    function render(incrementRenderCounter) {\r\n        if (!ctrl.data) {\r\n            return;\r\n        }\r\n\r\n        data = ctrl.data;\r\n        panel = ctrl.panel;\r\n\r\n        if (setElementHeight()) {\r\n            addPieChart();\r\n        }\r\n        if (incrementRenderCounter) {\r\n            ctrl.renderingCompleted();\r\n        }\r\n    }\r\n}\r\n\r\n"]}