{"version":3,"sources":["../src/legend.js"],"names":["angular","kbn","$","module","directive","popoverSrv","$timeout","link","scope","elem","$container","firstRender","ctrl","panel","data","seriesList","i","linkSrv","$injector","get","events","on","series","color","render","getSeriesIndexForElement","el","parents","toggleSeries","e","currentTarget","index","seriesInfo","sortLegend","stat","legend","sort","sortDesc","openColorSelector","target","length","find","show","element","position","template","model","toggleAxis","colorSelected","changeSeriesColor","legendType","empty","append","showValues","values","percentage","tableLayout","toggleClass","header","_","sortBy","stats","reverse","total","valueName","currentLink","currentHrefTarget","hideEmpty","allIsNull","drilldowns","y","drilldown","regexp","RegExp","alias","label","test","scopedVars","separator","trim","split","j","repeat","value","getPanelLinkAnchorInfo","href","undefined","targetBlank","html","maxSize","size","substr","formatValue","pvalue","toFixed"],"mappings":"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","file":"legend.js","sourcesContent":["import angular from 'angular';\r\n//import _ from  'lodash';\r\nimport kbn from 'app/core/utils/kbn';\r\nimport $ from  'jquery';\r\nimport 'jquery.flot';\r\nimport 'jquery.flot.time';\r\n\r\nangular.module('grafana.directives').directive('piechartLegend', function(popoverSrv, $timeout) {\r\n  return {\r\n    link: function(scope, elem) {\r\n      var $container = $('<section class=\"graph-legend\"></section>');\r\n      var firstRender = true;\r\n      var ctrl = scope.ctrl;\r\n      var panel = ctrl.panel;\r\n      var data;\r\n      var seriesList;\r\n      var i;\r\n\t  var linkSrv = ctrl.$injector.get('linkSrv');\r\n\r\n      ctrl.events.on('render', function() {\r\n        data = ctrl.series;\r\n        if (data) {\r\n          for(var i in data) {\r\n            data[i].color = ctrl.data[i].color;\r\n          }\r\n          render();\r\n        }\r\n      });\r\n\r\n      function getSeriesIndexForElement(el) {\r\n        return el.parents('[data-series-index]').data('series-index');\r\n      }\r\n\r\n      function toggleSeries(e) {\r\n        var el = $(e.currentTarget);\r\n        var index = getSeriesIndexForElement(el);\r\n        var seriesInfo = seriesList[index];\r\n        ctrl.toggleSeries(seriesInfo, e);\r\n      }\r\n\r\n      function sortLegend(e) {\r\n        var el = $(e.currentTarget);\r\n        var stat = el.data('stat');\r\n\r\n        if (stat !== panel.legend.sort) { panel.legend.sortDesc = null; }\r\n\r\n        // if already sort ascending, disable sorting\r\n        if (panel.legend.sortDesc === false) {\r\n          panel.legend.sort = null;\r\n          panel.legend.sortDesc = null;\r\n          render();\r\n          return;\r\n        }\r\n\r\n        panel.legend.sortDesc = !panel.legend.sortDesc;\r\n        panel.legend.sort = stat;\r\n        render();\r\n      }\r\n\r\n      function openColorSelector(e) {\r\n        // if we clicked inside poup container ignore click\r\n        if ($(e.target).parents('.popover').length) {\r\n          return;\r\n        }\r\n\r\n        var el = $(e.currentTarget).find('.fa-minus');\r\n        var index = getSeriesIndexForElement(el);\r\n        var series = seriesList[index];\r\n\r\n        $timeout(function() {\r\n          popoverSrv.show({\r\n            element: el[0],\r\n            position: 'bottom center',\r\n            template: '<gf-color-picker></gf-color-picker>',\r\n            model: {\r\n              series: series,\r\n              toggleAxis: function() {},\r\n              colorSelected: function(color) {\r\n                ctrl.changeSeriesColor(series, color);\r\n              }\r\n            },\r\n          });\r\n        });\r\n      }\r\n\r\n      function render() {\r\n        if(panel.legendType === 'On graph') {\r\n          $container.empty();\r\n          return;\r\n        }\r\n\r\n        if (firstRender) {\r\n          elem.append($container);\r\n          $container.on('click', '.graph-legend-icon', openColorSelector);\r\n          $container.on('click', 'th', sortLegend);\r\n          firstRender = false;\r\n        }\r\n\r\n        seriesList = data;\r\n\r\n        $container.empty();\r\n\r\n        var showValues = panel.legend.values || panel.legend.percentage;\r\n        var tableLayout = (\r\n            panel.legendType === 'Under graph' ||\r\n            panel.legendType === 'Right side'\r\n            ) && showValues;\r\n\r\n\r\n        $container.toggleClass('graph-legend-table', tableLayout);\r\n\r\n        if (tableLayout) {\r\n          var header = '<tr><th colspan=\"2\" style=\"text-align:left\"></th>';\r\n          if (panel.legend.values) {\r\n            header += '<th class=\"pointer\">values</th>';\r\n          }\r\n          if (panel.legend.percentage) {\r\n            header += '<th class=\"pointer\">percentage</th>';\r\n          }\r\n          header += '</tr>';\r\n          $container.append($(header));\r\n        }\r\n\r\n        if (panel.legend.sort) {\r\n          seriesList = _.sortBy(seriesList, function(series) {\r\n            return series.stats[panel.legend.sort];\r\n          });\r\n          if (panel.legend.sortDesc) {\r\n            seriesList = seriesList.reverse();\r\n          }\r\n        }\r\n\r\n        if (panel.legend.percentage) {\r\n          var total = 0;\r\n          for (i = 0; i < seriesList.length; i++) {\r\n            total += seriesList[i].stats[ctrl.panel.valueName];\r\n          }\r\n        }\r\n\r\n        for (i = 0; i < seriesList.length; i++) {\r\n          var series = seriesList[i];\r\n\t\t      var currentLink = \"#\";\r\n\t\t      var currentHrefTarget = \"_self\";\r\n\r\n          // ignore empty series\r\n          if (panel.legend.hideEmpty && series.allIsNull) {\r\n             continue;\r\n          }\r\n          // ignore series excluded via override\r\n          if (!series.legend) {\r\n             continue;\r\n          }\r\n\r\n          // ######## START JIRA RL-607 ##################\r\n          if(panel.drilldowns && panel.drilldowns.length >0) {\r\n            for (var y = 0; y < panel.drilldowns.length; y++) {\r\n\r\n              var drilldown = panel.drilldowns[y];\r\n              var regexp = new RegExp(drilldown.alias);\r\n              var alias = series.label;\r\n              if (regexp.test(alias)) {\r\n                 var scopedVars = {};\r\n                 scopedVars[\"alias\"] = {\"value\": alias};\r\n\r\n                 if (drilldown.separator && drilldown.separator.trim().length > 0) {\r\n                   var values = alias.split(drilldown.separator);\r\n                   for (var j = 0; j < values.length; j++) {\r\n                     scopedVars[\"alias\" + j] = {\"value\": values[j]};\r\n                   }\r\n                 }\r\n\r\n                 //add panel.scopedVars for repeat var\r\n                 if (panel.repeat && panel.scopedVars[panel.repeat] && panel.scopedVars[panel.repeat].value) {\r\n                   scopedVars[panel.repeat] = {\"value\": panel.scopedVars[panel.repeat].value};\r\n                 }\r\n\r\n                 var link = linkSrv.getPanelLinkAnchorInfo(drilldown, scopedVars);\r\n                 if (link.href != undefined) { \r\n                   currentLink = link.href;\r\n                 }\r\n\r\n                 if (drilldown.targetBlank) {\r\n                   currentHrefTarget = \"_blank\";\r\n                 } else {\r\n                   currentHrefTarget = \"_self\";\r\n                 }\r\n              }\r\n           }\r\n         }\r\n          // ######## END JIRA RL-607 ##################\r\n\r\n          var html = '<div class=\"graph-legend-series';\r\n          html += '\" data-series-index=\"' + i + '\">';\r\n          html += '<span class=\"graph-legend-icon\" style=\"float:none;\">';\r\n          html += '<i class=\"fa fa-minus pointer\" style=\"color:' + series.color + '\"></i>';\r\n          html += '</span>';\r\n          html += '<span class=\"graph-legend-alias\" style=\"float:none;\">';\r\n\r\n          html += '<a ';\r\n\r\n          if (currentLink != \"#\") {\r\n            // add href + target attributes based on the drilldown information\r\n            html += ' href=\"'+ currentLink +'\" target=\"'+ currentHrefTarget + '\" ';\r\n          } \r\n\r\n          html += 'title=\"'+ series.label + '\">';\t\t  \r\n\r\n          if (panel.legend.maxSize>0 && series.label.length>0 && panel.legend.maxSize < series.label.length) {\r\n              var size = panel.legend.maxSize/2;\r\n              html += `${series.label.substr(0,size)}...${series.label.substr(series.label.length-size)}`;\r\n          }else{\r\n             html += series.label;\r\n          }\r\n\r\n          html += '</a></span>';\r\n\r\n          if (showValues && tableLayout) {\r\n            var value = series.formatValue(series.stats[ctrl.panel.valueName]);\r\n            if (panel.legend.values) {\r\n              html += '<div class=\"graph-legend-value\">' + ctrl.formatValue(value) + '</div>';\r\n            }\r\n            if (total) {\r\n              var pvalue = ((value / total) * 100).toFixed(2) + '%';\r\n              html += '<div class=\"graph-legend-value\">' + pvalue +'</div>';\r\n            }\r\n          }\r\n\r\n          html += '</div>';\r\n          $container.append($(html));\r\n        }\r\n       }\r\n     }\r\n  };\r\n});\r\n"]}